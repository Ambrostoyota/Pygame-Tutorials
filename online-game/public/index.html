<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ® Legend of Heroes - Online Epic Adventure</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    @keyframes starfield {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(0, 1000px, 0); }
    }
    
    @keyframes glow {
      0%, 100% { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00; }
      50% { text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00, 0 0 50px #00ff00; }
    }
    
    @keyframes float {
      0%, 100% { transform: translate3d(0, 0, 0); }
      50% { transform: translate3d(0, -10px, 0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: scale3d(0.9, 0.9, 1); }
      to { opacity: 1; transform: scale3d(1, 1, 1); }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: 'Cinzel', serif;
      color: white;
      overflow: hidden;
      position: relative;
      will-change: auto;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      background: radial-gradient(2px 2px at 20% 30%, white, transparent),
                  radial-gradient(2px 2px at 60% 70%, white, transparent),
                  radial-gradient(1px 1px at 50% 50%, white, transparent),
                  radial-gradient(1px 1px at 80% 10%, white, transparent),
                  radial-gradient(2px 2px at 90% 60%, white, transparent);
      background-size: 200px 200px;
      animation: starfield 50s linear infinite;
      opacity: 0.5;
    }
    
    #gameContainer {
      position: relative;
      background: linear-gradient(to bottom, rgba(15, 52, 96, 0.95), rgba(26, 26, 46, 0.95));
      border: 4px solid;
      border-image: linear-gradient(45deg, #00ff00, #00ffff, #ff00ff, #00ff00) 1;
      box-shadow: 0 0 50px rgba(0, 255, 255, 0.5), 
                  inset 0 0 50px rgba(0, 0, 0, 0.5);
      animation: fadeIn 1s ease-out;
      backdrop-filter: blur(10px);
      will-change: transform;
      transform: translateZ(0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }
    
    #canvas {
      display: block;
      image-rendering: crisp-edges;
      filter: contrast(1.1) brightness(1.05);
      will-change: contents;
      transform: translateZ(0);
    }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0,255,0,0.8), 2px 2px 4px rgba(0,0,0,0.8);
      pointer-events: none;
      animation: glow 2s ease-in-out infinite;
    }
    
    #storyPanel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.7));
      padding: 20px;
      transform: translateY(100%);
      transition: transform 0.5s ease-out;
      border-top: 2px solid #00ff00;
    }
    
    #storyPanel.active {
      transform: translateY(0);
    }
    
    #storyText {
      font-family: 'Cinzel', serif;
      font-size: 16px;
      color: #ffffff;
      line-height: 1.6;
      margin-bottom: 10px;
      text-shadow: 0 0 5px rgba(0,255,0,0.5);
    }
    
    #storySpeaker {
      font-family: 'Press Start 2P', monospace;
      font-size: 12px;
      color: #00ff00;
      margin-bottom: 5px;
    }
    
    #particleCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 10;
    }
    
    #audioControls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      z-index: 1000;
    }
    
    .audio-btn {
      background: rgba(0,0,0,0.7);
      border: 2px solid #00ff00;
      color: #00ff00;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .audio-btn:hover {
      background: rgba(0,255,0,0.2);
      box-shadow: 0 0 15px rgba(0,255,0,0.5);
    }
    
    .audio-btn.active {
      background: rgba(0,255,0,0.3);
      animation: glow 1s ease-in-out infinite;
    }
    
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 10px;
    }
    
    .btn {
      background: linear-gradient(135deg, rgba(0,255,0,0.3), rgba(0,200,0,0.3));
      border: 2px solid #00ff00;
      color: white;
      padding: 15px 25px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      box-shadow: 0 0 15px rgba(0,255,0,0.3);
      transition: all 0.3s;
    }
    
    .btn:active {
      background: linear-gradient(135deg, rgba(0,255,0,0.5), rgba(0,200,0,0.5));
      box-shadow: 0 0 25px rgba(0,255,0,0.6);
      transform: scale(0.95);
    }
    #playerList {
      position: absolute;
      top: 60px;
      right: 10px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(0,50,0,0.8));
      padding: 12px;
      border-radius: 10px;
      border: 2px solid rgba(0,255,0,0.5);
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(0,255,0,0.3);
    }
    
    .player-item {
      padding: 8px;
      margin: 5px 0;
      background: linear-gradient(90deg, rgba(0,255,0,0.1), rgba(0,200,0,0.1));
      border-radius: 5px;
      border-left: 3px solid #00ff00;
      transition: all 0.3s;
      animation: float 3s ease-in-out infinite;
    }
    
    .player-item:hover {
      background: linear-gradient(90deg, rgba(0,255,0,0.2), rgba(0,200,0,0.2));
      transform: translateX(-5px);
    }
    
    #roomPanel {
      position: absolute;
      top: 60px;
      left: 10px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(0,50,0,0.8));
      padding: 15px;
      border-radius: 10px;
      border: 2px solid rgba(0,255,0,0.5);
      font-size: 14px;
      max-width: 250px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(0,255,0,0.3);
    }
    
    #roomPanel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #00ff00;
      font-family: 'Press Start 2P', monospace;
      text-shadow: 0 0 10px rgba(0,255,0,0.8);
    }
    
    .room-item {
      padding: 10px;
      margin: 8px 0;
      background: linear-gradient(135deg, rgba(0,255,0,0.1), rgba(0,200,0,0.05));
      border-radius: 8px;
      border: 1px solid rgba(0,255,0,0.3);
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .room-item:hover {
      background: linear-gradient(135deg, rgba(0,255,0,0.3), rgba(0,200,0,0.2));
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0,255,0,0.5);
    }
    
    .room-item.current {
      background: linear-gradient(135deg, rgba(0,255,0,0.4), rgba(0,200,0,0.3));
      border: 2px solid #00ff00;
      box-shadow: 0 0 20px rgba(0,255,0,0.6), inset 0 0 10px rgba(0,255,0,0.2);
    }
    
    #createRoomBtn {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      background: linear-gradient(135deg, #00ff00, #00cc00);
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 0 15px rgba(0,255,0,0.5);
    }
    
    #createRoomBtn:hover {
      background: linear-gradient(135deg, #00ff00, #00dd00);
      box-shadow: 0 0 25px rgba(0,255,0,0.8);
      transform: translateY(-2px);
    }
    
    #connectionStatus {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-family: 'Press Start 2P', monospace;
      background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(0,50,0,0.9));
      padding: 30px 50px;
      border-radius: 15px;
      border: 3px solid #00ff00;
      box-shadow: 0 0 40px rgba(0,255,0,0.6);
      animation: glow 2s ease-in-out infinite;
      z-index: 9999;
    }
    
    #loadingSpinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(0, 255, 0, 0.3);
      border-top-color: #00ff00;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto 0;
    }
    
    #fps {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-family: monospace;
      color: #00ff00;
      z-index: 100;
    }
    
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(0,255,0,0.95), rgba(0,200,0,0.95));
      color: #000;
      padding: 15px 30px;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 0 30px rgba(0,255,0,0.8);
      animation: pulse 0.5s ease-in-out;
      z-index: 10000;
      pointer-events: none;
    }
    
    .game-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(0,50,0,0.9));
      border: 3px solid #00ff00;
      border-radius: 15px;
      padding: 20px;
      min-width: 400px;
      max-width: 80vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 50px rgba(0,255,0,0.8);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }
    
    .game-panel h2 {
      font-family: 'Press Start 2P', monospace;
      font-size: 18px;
      color: #00ff00;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 15px rgba(0,255,0,0.8);
    }
    
    .game-panel h3 {
      font-family: 'Cinzel', serif;
      font-size: 14px;
      color: #00ffff;
      margin: 10px 0;
    }
    
    .close-btn {
      display: block;
      margin: 20px auto 0;
      padding: 10px 30px;
      background: linear-gradient(135deg, #ff0000, #cc0000);
      border: 2px solid #ff0000;
      color: white;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .close-btn:hover {
      background: linear-gradient(135deg, #ff3333, #ff0000);
      box-shadow: 0 0 20px rgba(255,0,0,0.8);
    }
    
    .item-slot {
      display: inline-block;
      width: 60px;
      height: 60px;
      margin: 5px;
      background: rgba(0,0,0,0.8);
      border: 2px solid #333;
      border-radius: 5px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .item-slot:hover {
      border-color: #00ff00;
      box-shadow: 0 0 15px rgba(0,255,0,0.5);
    }
    
    .item-slot.rare { border-color: #0070dd; }
    .item-slot.epic { border-color: #a335ee; }
    .item-slot.legendary { border-color: #ff8000; }
    
    .skill-btn {
      display: inline-block;
      width: 80px;
      height: 80px;
      margin: 10px;
      background: linear-gradient(135deg, rgba(0,100,0,0.8), rgba(0,50,0,0.8));
      border: 3px solid #00ff00;
      border-radius: 10px;
      color: white;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .skill-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(0,255,0,0.8);
    }
    
    .skill-btn.locked {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .quest-item {
      background: rgba(0,50,0,0.5);
      border-left: 4px solid #00ff00;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    .quest-item:hover {
      background: rgba(0,100,0,0.7);
      transform: translateX(5px);
    }
    
    .quest-item.completed {
      border-left-color: #ffd700;
      opacity: 0.7;
    }
    
    @media (max-width: 600px) {
      #canvas {
        max-width: 100vw;
        height: auto;
      }
      #controls {
        display: flex;
      }
      #storyText {
        font-size: 14px;
      }
      .game-panel {
        min-width: 90vw;
      }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="canvas" width="500" height="480"></canvas>
    <canvas id="particleCanvas" width="500" height="480"></canvas>
    
    <div id="fps">FPS: 0</div>
    
    <!-- ä¸»èœå•æŒ‰é’® -->
    <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 200;">
      <button class="audio-btn" id="menuCharacter">ğŸ‘¤ è§’è‰²</button>
      <button class="audio-btn" id="menuInventory">ğŸ’ èƒŒåŒ…</button>
      <button class="audio-btn" id="menuSkills">âš”ï¸ æŠ€èƒ½</button>
      <button class="audio-btn" id="menuQuests">ğŸ“œ ä»»åŠ¡</button>
      <button class="audio-btn" id="menuMap">ğŸ—ºï¸ åœ°å›¾</button>
      <button class="audio-btn" id="menuGuild">ğŸ° å…¬ä¼š</button>
      <button class="audio-btn" id="menuPVP">âš”ï¸ PVP</button>
      <button class="audio-btn" id="menuShop">ğŸ›’ å•†åº—</button>
      <button class="audio-btn" id="menuFriends">ğŸ‘¥ å¥½å‹</button>
      <button class="audio-btn" id="menuMail">ğŸ“§ é‚®ä»¶</button>
      <button class="audio-btn" id="menuAuction">ğŸ’° æ‹å–</button>
      <button class="audio-btn" id="menuChat">ğŸ’¬ èŠå¤©</button>
    </div>
    
    <div id="audioControls">
      <button class="audio-btn" id="musicBtn">ğŸµ Music</button>
      <button class="audio-btn" id="sfxBtn">ğŸ”Š SFX</button>
    </div>
    
    <div id="ui">
      <div id="health">â¤ï¸ HP: 100/100</div>
      <div id="mana">ğŸ’§ MP: 100/100</div>
      <div id="level">â­ Lv.1 (0/100)</div>
      <div id="score">ğŸ† Score: 0</div>
    </div>
    
    <div id="playerList"></div>
    
    <div id="roomPanel">
      <h3>ğŸ  ROOMS</h3>
      <div id="roomList"></div>
      <button id="createRoomBtn">â• CREATE</button>
    </div>
    
    <div id="storyPanel">
      <div id="storySpeaker"></div>
      <div id="storyText"></div>
    </div>
    
    <!-- è§’è‰²é¢æ¿ -->
    <div id="characterPanel" class="game-panel" style="display:none;">
      <h2>ğŸ‘¤ è§’è‰²ä¿¡æ¯</h2>
      <div id="charInfo"></div>
      <button class="close-btn" onclick="document.getElementById('characterPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- èƒŒåŒ…é¢æ¿ -->
    <div id="inventoryPanel" class="game-panel" style="display:none;">
      <h2>ğŸ’ èƒŒåŒ…</h2>
      <div id="inventoryGrid"></div>
      <button class="close-btn" onclick="document.getElementById('inventoryPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- æŠ€èƒ½é¢æ¿ -->
    <div id="skillsPanel" class="game-panel" style="display:none;">
      <h2>âš”ï¸ æŠ€èƒ½æ ‘</h2>
      <div id="skillTree"></div>
      <button class="close-btn" onclick="document.getElementById('skillsPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- ä»»åŠ¡é¢æ¿ -->
    <div id="questsPanel" class="game-panel" style="display:none;">
      <h2>ğŸ“œ ä»»åŠ¡æ—¥å¿—</h2>
      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
          <h3>ä¸»çº¿ä»»åŠ¡</h3>
          <div id="mainQuests"></div>
        </div>
        <div style="flex:1;">
          <h3>æ¯æ—¥ä»»åŠ¡</h3>
          <div id="dailyQuests"></div>
        </div>
      </div>
      <button class="close-btn" onclick="document.getElementById('questsPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- åœ°å›¾é¢æ¿ -->
    <div id="mapPanel" class="game-panel" style="display:none;">
      <h2>ğŸ—ºï¸ ä¸–ç•Œåœ°å›¾</h2>
      <div id="worldMap"></div>
      <button class="close-btn" onclick="document.getElementById('mapPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- å…¬ä¼šé¢æ¿ -->
    <div id="guildPanel" class="game-panel" style="display:none;">
      <h2>ğŸ° å…¬ä¼š</h2>
      <div id="guildInfo"></div>
      <button class="close-btn" onclick="document.getElementById('guildPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- PVPé¢æ¿ -->
    <div id="pvpPanel" class="game-panel" style="display:none;">
      <h2>âš”ï¸ PVPç«æŠ€åœº</h2>
      <div id="pvpArenas"></div>
      <div id="pvpRanking"></div>
      <button class="close-btn" onclick="document.getElementById('pvpPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- å•†åº—é¢æ¿ -->
    <div id="shopPanel" class="game-panel" style="display:none;">
      <h2>ğŸ›’ ç¥ç§˜å•†åº—</h2>
      <div id="shopItems"></div>
      <button class="close-btn" onclick="document.getElementById('shopPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- å¥½å‹é¢æ¿ -->
    <div id="friendsPanel" class="game-panel" style="display:none;">
      <h2>ğŸ‘¥ å¥½å‹åˆ—è¡¨</h2>
      <div id="friendsList"></div>
      <button class="close-btn" onclick="document.getElementById('friendsPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- é‚®ä»¶é¢æ¿ -->
    <div id="mailPanel" class="game-panel" style="display:none;">
      <h2>ğŸ“§ é‚®ä»¶ç³»ç»Ÿ</h2>
      <div id="mailList"></div>
      <button class="close-btn" onclick="document.getElementById('mailPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- æ‹å–è¡Œé¢æ¿ -->
    <div id="auctionPanel" class="game-panel" style="display:none;">
      <h2>ğŸ’° æ‹å–è¡Œ</h2>
      <div id="auctionItems"></div>
      <button class="close-btn" onclick="document.getElementById('auctionPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <!-- èŠå¤©é¢æ¿ -->
    <div id="chatPanel" class="game-panel" style="display:none;">
      <h2>ğŸ’¬ èŠå¤©é¢‘é“</h2>
      <div id="chatChannels"></div>
      <div id="chatMessages" style="height:300px; overflow-y:auto; background:#222; padding:10px; margin:10px 0;"></div>
      <div style="display:flex; gap:5px;">
        <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1; padding:5px; background:#333; border:1px solid #666; color:#fff;">
        <button onclick="sendChatMessage()" style="padding:5px 15px;">å‘é€</button>
      </div>
      <button class="close-btn" onclick="document.getElementById('chatPanel').style.display='none'">å…³é—­</button>
    </div>
    
    <div id="connectionStatus">
      ğŸ”Œ Connecting...
      <div id="loadingSpinner"></div>
    </div>
    
    <!-- Mobile controls -->
    <div id="controls">
      <button class="btn" id="leftBtn">â—€ï¸</button>
      <button class="btn" id="jumpBtn">ğŸ”¼</button>
      <button class="btn" id="shootBtn">ğŸ”«</button>
      <button class="btn" id="rightBtn">â–¶ï¸</button>
    </div>
  </div>
  
  <!-- Audio Elements -->
  <audio id="bgMusic" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_d1718ab41b.mp3" type="audio/mp3">
  </audio>
  <audio id="shootSound">
    <source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3" type="audio/mp3">
  </audio>
  <audio id="hitSound">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c6f5764d24.mp3" type="audio/mp3">
  </audio>

  <script src="game-data.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ç©å®¶æ‰©å±•æ•°æ®
    const playerData = {
      class: 'warrior',
      level: 1,
      exp: 0,
      maxExp: 100,
      hp: 100,
      maxHp: 100,
      mp: 100,
      maxMp: 100,
      stats: { str: 10, agi: 5, int: 3, vit: 8 },
      gold: 0,
      honor: 0,
      inventory: [],
      equipment: {},
      skills: [],
      quests: { active: [], completed: [] },
      achievements: [],
      pets: [],
      mounts: [],
      professions: {},
      guild: null,
      pvpRating: 0,
      friends: [],
      mail: [],
      chatHistory: [],
      tradeHistory: [],
      alignment: 'neutral', // good/neutral/evil
      storyProgress: { chapter: 1, act: 1, choices: [] }
    };
    
    // UIç®¡ç†
    const UI = {
      showCharacter() {
        const panel = document.getElementById('characterPanel');
        const info = document.getElementById('charInfo');
        const classData = GAME_DATA.classes[playerData.class];
        
        info.innerHTML = `
          <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:60px;">${classData.icon}</div>
            <h3>${classData.name} - ç­‰çº§ ${playerData.level}</h3>
            <div style="margin:10px 0;">
              <div>ğŸ’° é‡‘å¸: ${playerData.gold.toLocaleString()}</div>
              <div>ğŸ† è£èª‰: ${playerData.honor}</div>
              <div>â­ ç»éªŒ: ${playerData.exp}/${playerData.maxExp}</div>
            </div>
          </div>
          <div style="background:rgba(0,0,0,0.5); padding:15px; border-radius:10px;">
            <h3>å±æ€§</h3>
            <div>ğŸ’ª åŠ›é‡: ${playerData.stats.str}</div>
            <div>ğŸƒ æ•æ·: ${playerData.stats.agi}</div>
            <div>ğŸ§  æ™ºåŠ›: ${playerData.stats.int}</div>
            <div>â¤ï¸ ä½“è´¨: ${playerData.stats.vit}</div>
          </div>
          <div style="background:rgba(0,0,0,0.5); padding:15px; border-radius:10px; margin-top:15px;">
            <h3>æˆ˜æ–—æ•°æ®</h3>
            <div>âš”ï¸ æ”»å‡»åŠ›: ${this.calculateAttack()}</div>
            <div>ğŸ›¡ï¸ é˜²å¾¡åŠ›: ${this.calculateDefense()}</div>
            <div>ğŸ’¥ æš´å‡»ç‡: ${this.calculateCrit()}%</div>
            <div>âœ¨ æš´å‡»ä¼¤å®³: ${this.calculateCritDamage()}%</div>
          </div>
        `;
        panel.style.display = 'block';
      },
      
      showInventory() {
        const panel = document.getElementById('inventoryPanel');
        const grid = document.getElementById('inventoryGrid');
        
        let html = '<div style="display:grid; grid-template-columns:repeat(8,70px); gap:5px;">';
        for (let i = 0; i < 64; i++) {
          const item = playerData.inventory[i];
          if (item) {
            html += `<div class="item-slot ${item.rarity}" title="${item.name}">
              <div style="text-align:center; padding:10px;">${item.icon || 'ğŸ“¦'}</div>
              <div style="font-size:10px; text-align:center;">${item.name.slice(0,6)}</div>
            </div>`;
          } else {
            html += `<div class="item-slot"></div>`;
          }
        }
        html += '</div>';
        html += `<div style="margin-top:20px; text-align:center; color:#ffd700;">
          èƒŒåŒ…ç©ºé—´: ${playerData.inventory.length}/64
        </div>`;
        
        grid.innerHTML = html;
        panel.style.display = 'block';
      },
      
      showSkills() {
        const panel = document.getElementById('skillsPanel');
        const tree = document.getElementById('skillTree');
        const classData = GAME_DATA.classes[playerData.class];
        
        let html = `<div style="text-align:center; margin-bottom:20px;">
          <h3>${classData.name}æŠ€èƒ½æ ‘</h3>
          <div>å¯ç”¨æŠ€èƒ½ç‚¹: ${playerData.skillPoints || 0}</div>
        </div>`;
        
        html += '<div style="display:flex; flex-wrap:wrap; justify-content:center;">';
        classData.skills.forEach(skill => {
          const unlocked = playerData.level >= skill.level;
          const learned = playerData.skills.includes(skill.id);
          
          html += `
            <div class="skill-btn ${!unlocked ? 'locked' : ''}" 
                 title="${skill.desc}">
              <div style="font-size:30px; margin-top:10px;">âš”ï¸</div>
              <div style="font-size:10px;">${skill.name}</div>
              <div style="font-size:8px;">Lv.${skill.level}</div>
              ${learned ? '<div style="position:absolute; top:5px; right:5px; color:#00ff00;">âœ“</div>' : ''}
            </div>
          `;
        });
        html += '</div>';
        
        tree.innerHTML = html;
        panel.style.display = 'block';
      },
      
      showQuests() {
        const panel = document.getElementById('questsPanel');
        const main = document.getElementById('mainQuests');
        const daily = document.getElementById('dailyQuests');
        
        // ä¸»çº¿ä»»åŠ¡
        let mainHtml = '';
        GAME_DATA.quests.main.slice(0, 5).forEach(quest => {
          const completed = playerData.quests.completed.includes(quest.id);
          mainHtml += `
            <div class="quest-item ${completed ? 'completed' : ''}">
              <div style="font-weight:bold; color:#ffd700;">ç¬¬${quest.chapter}ç« : ${quest.name}</div>
              <div style="font-size:12px; margin:5px 0;">${quest.desc}</div>
              <div style="font-size:11px; color:#aaa;">
                å¥–åŠ±: ğŸ’°${quest.rewards.gold} ç»éªŒ${quest.rewards.exp}
              </div>
              ${completed ? '<div style="color:#00ff00;">âœ“ å·²å®Œæˆ</div>' : '<div style="color:#ffaa00;">è¿›è¡Œä¸­...</div>'}
            </div>
          `;
        });
        
        // æ¯æ—¥ä»»åŠ¡
        let dailyHtml = '';
        GAME_DATA.quests.daily.forEach(quest => {
          dailyHtml += `
            <div class="quest-item">
              <div style="font-weight:bold; color:#00ffff;">${quest.name}</div>
              <div style="font-size:12px; margin:5px 0;">${quest.desc}</div>
              <div style="font-size:11px; color:#aaa;">
                å¥–åŠ±: ğŸ’°${quest.rewards.gold} ç»éªŒ${quest.rewards.exp}
              </div>
              <div style="margin-top:5px;">
                <div style="background:#333; height:10px; border-radius:5px; overflow:hidden;">
                  <div style="background:#00ff00; height:100%; width:0%;"></div>
                </div>
              </div>
            </div>
          `;
        });
        
        main.innerHTML = mainHtml;
        daily.innerHTML = dailyHtml;
        panel.style.display = 'block';
      },
      
      showMap() {
        const panel = document.getElementById('mapPanel');
        const map = document.getElementById('worldMap');
        
        let html = '<div style="display:grid; grid-template-columns:repeat(2,1fr); gap:15px;">';
        GAME_DATA.maps.forEach(area => {
          html += `
            <div style="background:rgba(0,50,0,0.5); padding:15px; border-radius:10px; border:2px solid #00ff00; cursor:pointer;" 
                 onmouseover="this.style.background='rgba(0,100,0,0.7)'"
                 onmouseout="this.style.background='rgba(0,50,0,0.5)'">
              <h3 style="color:#00ff00;">${area.name}</h3>
              <div style="font-size:12px; color:#aaa;">ç­‰çº§: ${area.level}</div>
              <div style="font-size:11px; margin-top:5px;">
                æ€ªç‰©: ${area.monsters.join(', ')}
              </div>
              <div style="font-size:11px; color:#ff0000; margin-top:5px;">
                BOSS: ${area.boss}
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        map.innerHTML = html;
        panel.style.display = 'block';
      },
      
      showGuild() {
        const panel = document.getElementById('guildPanel');
        const info = document.getElementById('guildInfo');
        
        if (!playerData.guild) {
          info.innerHTML = `
            <div style="text-align:center; padding:40px;">
              <div style="font-size:60px;">ğŸ°</div>
              <h3>ä½ è¿˜æ²¡æœ‰åŠ å…¥å…¬ä¼š</h3>
              <button class="audio-btn" style="margin-top:20px;">åˆ›å»ºå…¬ä¼š</button>
              <button class="audio-btn" style="margin-top:10px;">æŸ¥æ‰¾å…¬ä¼š</button>
            </div>
          `;
        } else {
          info.innerHTML = `
            <div style="text-align:center;">
              <h3>${playerData.guild.name}</h3>
              <div>ç­‰çº§: ${playerData.guild.level}</div>
              <div>æˆå‘˜: ${playerData.guild.members}/100</div>
            </div>
            <div style="margin-top:20px;">
              <h3>å…¬ä¼šæŠ€èƒ½</h3>
              ${GAME_DATA.guild.skills.map(skill => `
                <div class="quest-item">
                  <div style="font-weight:bold;">${skill.name}</div>
                  <div style="font-size:12px;">${skill.effect}</div>
                  <div style="font-size:11px; color:#ffd700;">æ¶ˆè€—: ${skill.cost} å…¬ä¼šèµ„é‡‘</div>
                </div>
              `).join('')}
            </div>
          `;
        }
        
        panel.style.display = 'block';
      },
      
      showPVP() {
        const panel = document.getElementById('pvpPanel');
        const arenas = document.getElementById('pvpArenas');
        const ranking = document.getElementById('pvpRanking');
        
        let arenasHtml = '<h3>ç«æŠ€åœºæ¨¡å¼</h3>';
        GAME_DATA.pvp.arenas.forEach(arena => {
          arenasHtml += `
            <div class="quest-item" style="cursor:pointer;">
              <div style="font-weight:bold; font-size:16px;">${arena.name}</div>
              <div style="font-size:14px; color:#00ffff;">${arena.mode}</div>
              <div style="font-size:12px; margin-top:5px;">
                å¥–åŠ±: è£èª‰${arena.rewards.honor} è¯„åˆ†+${arena.rewards.rating}
              </div>
              <button class="audio-btn" style="margin-top:10px;">è¿›å…¥æˆ˜æ–—</button>
            </div>
          `;
        });
        
        let rankingHtml = '<h3 style="margin-top:20px;">æ®µä½ç³»ç»Ÿ</h3>';
        const currentRating = playerData.pvpRating || 0;
        GAME_DATA.pvp.ranks.forEach(rank => {
          const achieved = currentRating >= rank.rating;
          rankingHtml += `
            <div class="quest-item ${achieved ? 'completed' : ''}" style="opacity:${achieved ? 1 : 0.5};">
              <div style="font-weight:bold;">${rank.tier.toUpperCase()}</div>
              <div style="font-size:12px;">è¯„åˆ†è¦æ±‚: ${rank.rating}</div>
              <div style="font-size:11px; color:#ffd700;">
                å¥–åŠ±: ${rank.rewards.title}
              </div>
              ${achieved ? '<div style="color:#00ff00;">âœ“ å·²è¾¾æˆ</div>' : ''}
            </div>
          `;
        });
        
        arenas.innerHTML = arenasHtml;
        ranking.innerHTML = rankingHtml;
        panel.style.display = 'block';
      },
      
      showShop() {
        const panel = document.getElementById('shopPanel');
        const items = document.getElementById('shopItems');
        
        let html = '<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px;">';
        
        // å±•ç¤ºä¸€äº›ä¼ è¯´è£…å¤‡
        const legendaryItems = GAME_DATA.equipment.weapons.filter(w => w.rarity === 'legendary');
        legendaryItems.forEach(item => {
          html += `
            <div style="background:rgba(255,128,0,0.2); padding:15px; border-radius:10px; border:2px solid #ff8000; text-align:center;">
              <div style="font-size:40px;">âš”ï¸</div>
              <div style="font-weight:bold; color:#ff8000;">${item.name}</div>
              <div style="font-size:12px; color:#aaa; margin:5px 0;">
                ç­‰çº§è¦æ±‚: ${item.level}
              </div>
              <div style="font-size:14px; color:#ffd700; margin:10px 0;">
                ğŸ’° ${(item.level * 10000).toLocaleString()} é‡‘å¸
              </div>
              <button class="audio-btn">è´­ä¹°</button>
            </div>
          `;
        });
        html += '</div>';
        
        items.innerHTML = html;
        panel.style.display = 'block';
      },
      
      calculateAttack() {
        return playerData.stats.str * 2 + playerData.level * 5;
      },
      
      calculateDefense() {
        return playerData.stats.vit * 2 + playerData.level * 3;
      },
      
      calculateCrit() {
        return Math.min(50, playerData.stats.agi * 0.5 + 5);
      },
      
      calculateCritDamage() {
        return 150 + playerData.stats.str * 2;
      },
      
      showFriends() {
        const panel = document.getElementById('friendsPanel');
        const list = document.getElementById('friendsList');
        const social = GAME_DATA.social;
        
        list.innerHTML = `
          <div style="margin-bottom:15px;">
            <p>ğŸ“Š å¥½å‹ä¸Šé™: ${social.friendsList.maxFriends}</p>
            <p>ğŸ‘¥ å½“å‰å¥½å‹: 0/${social.friendsList.maxFriends}</p>
          </div>
          <div style="display:flex; gap:10px; margin-bottom:10px;">
            ${social.friendsList.categories.map(cat => 
              `<button class="skill-btn">${cat}</button>`
            ).join('')}
          </div>
          <div style="background:#222; padding:10px; border-radius:5px;">
            <p style="color:#888; text-align:center;">æš‚æ— å¥½å‹</p>
            <p style="color:#666; font-size:12px; text-align:center; margin-top:10px;">
              åŠŸèƒ½: ${social.friendsList.features.join(' | ')}
            </p>
          </div>
        `;
        panel.style.display = 'block';
      },
      
      showMail() {
        const panel = document.getElementById('mailPanel');
        const list = document.getElementById('mailList');
        const mail = GAME_DATA.mail;
        
        list.innerHTML = `
          <div style="display:flex; gap:5px; margin-bottom:10px;">
            ${mail.types.map(type => 
              `<button class="skill-btn">${type.icon} ${type.name}</button>`
            ).join('')}
          </div>
          <div style="background:#222; padding:15px; border-radius:5px; margin-bottom:10px;">
            <p>ğŸ“¬ æ”¶ä»¶ç®±: 0/${mail.maxInbox}</p>
            <p>â­ ä¿å­˜: 0/${mail.maxSaved}</p>
          </div>
          <div style="background:#222; padding:10px; border-radius:5px;">
            <p style="color:#888; text-align:center;">æ”¶ä»¶ç®±ä¸ºç©º</p>
            <p style="color:#666; font-size:12px; margin-top:10px;">
              åŠŸèƒ½: ${mail.features.join(' | ')}
            </p>
          </div>
        `;
        panel.style.display = 'block';
      },
      
      showAuction() {
        const panel = document.getElementById('auctionPanel');
        const items = document.getElementById('auctionItems');
        const ah = GAME_DATA.trading.auctionHouse;
        
        items.innerHTML = `
          <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
            ${ah.categories.map(cat => 
              `<button class="skill-btn">${cat}</button>`
            ).join('')}
          </div>
          <div style="display:flex; gap:5px; margin-bottom:10px;">
            ${ah.rarities.map(rarity => 
              `<button class="skill-btn">${rarity}</button>`
            ).join('')}
          </div>
          <div style="background:#222; padding:15px; border-radius:5px; margin-bottom:10px;">
            <p>ğŸ’° ä¸Šæ¶è´¹: ${ah.fees.listingFee * 100}%</p>
            <p>ğŸ’¸ æ‰‹ç»­è´¹: ${ah.fees.successFee * 100}%</p>
            <p>â° æ—¶é•¿: ${ah.fees.duration.join('h / ')}h</p>
          </div>
          <div style="background:#222; padding:10px; border-radius:5px;">
            <h4>ğŸ”¥ çƒ­é—¨å•†å“</h4>
            ${GAME_DATA.equipment.weapons.filter(w => w.rarity === 'legendary').slice(0, 3).map(item => 
              `<div class="item-slot ${item.rarity}" style="margin:5px 0;">
                <strong>${item.name}</strong><br>
                <small>ğŸ’° èµ·æ‹ä»·: ${item.requiredLevel * 10000}é‡‘å¸</small>
              </div>`
            ).join('')}
            <p style="color:#666; font-size:12px; margin-top:10px;">
              åŠŸèƒ½: ${ah.features.join(' | ')}
            </p>
          </div>
        `;
        panel.style.display = 'block';
      },
      
      showChat() {
        const panel = document.getElementById('chatPanel');
        const channels = document.getElementById('chatChannels');
        const social = GAME_DATA.social;
        
        channels.innerHTML = social.chatChannels.map(ch => 
          `<button class="skill-btn" style="background:${ch.color}20; border-color:${ch.color};">
            ${ch.name} ${ch.cooldown > 0 ? `(${ch.cooldown}s)` : ''}
          </button>`
        ).join('');
        
        panel.style.display = 'block';
      }
    };
    
    // èŠå¤©å‘é€å‡½æ•°
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const messages = document.getElementById('chatMessages');
      if (input.value.trim()) {
        const msg = document.createElement('div');
        msg.style.marginBottom = '5px';
        msg.innerHTML = `<span style="color:#FFD700;">[${playerData.username}]</span> <span style="color:#fff;">${input.value}</span>`;
        messages.appendChild(msg);
        messages.scrollTop = messages.scrollHeight;
        input.value = '';
      }
    }
    
    // ç»‘å®šèœå•æŒ‰é’®
    document.getElementById('menuCharacter').addEventListener('click', () => UI.showCharacter());
    document.getElementById('menuInventory').addEventListener('click', () => UI.showInventory());
    document.getElementById('menuSkills').addEventListener('click', () => UI.showSkills());
    document.getElementById('menuQuests').addEventListener('click', () => UI.showQuests());
    document.getElementById('menuMap').addEventListener('click', () => UI.showMap());
    document.getElementById('menuGuild').addEventListener('click', () => UI.showGuild());
    document.getElementById('menuPVP').addEventListener('click', () => UI.showPVP());
    document.getElementById('menuShop').addEventListener('click', () => UI.showShop());
    document.getElementById('menuFriends').addEventListener('click', () => UI.showFriends());
    document.getElementById('menuMail').addEventListener('click', () => UI.showMail());
    document.getElementById('menuAuction').addEventListener('click', () => UI.showAuction());
    document.getElementById('menuChat').addEventListener('click', () => UI.showChat());
    
    // ç»éªŒå’Œå‡çº§ç³»ç»Ÿ
    function gainExp(amount) {
      playerData.exp += amount;
      if (playerData.exp >= playerData.maxExp) {
        levelUp();
      }
      updateUI();
    }
    
    function levelUp() {
      playerData.level++;
      playerData.exp = 0;
      playerData.maxExp = Math.floor(playerData.maxExp * 1.5);
      playerData.stats.str += 2;
      playerData.stats.agi += 2;
      playerData.stats.int += 2;
      playerData.stats.vit += 2;
      playerData.maxHp += 20;
      playerData.maxMp += 15;
      playerData.hp = playerData.maxHp;
      playerData.mp = playerData.maxMp;
      playerData.skillPoints = (playerData.skillPoints || 0) + 1;
      
      showToast(`ğŸ‰ å‡çº§ï¼ç­‰çº§æå‡è‡³ ${playerData.level}`, 3000);
      createExplosion(250, 240, '#FFD700');
    }
    
    // æ›´æ–°UIæ˜¾ç¤º
    function updateUIData() {
      document.getElementById('health').textContent = `â¤ï¸ HP: ${playerData.hp}/${playerData.maxHp}`;
      document.getElementById('mana').textContent = `ğŸ’§ MP: ${playerData.mp}/${playerData.maxMp}`;
      document.getElementById('level').textContent = `â­ Lv.${playerData.level} (${playerData.exp}/${playerData.maxExp})`;
      document.getElementById('score').textContent = `ğŸ† ${playerData.gold.toLocaleString()}é‡‘å¸`;
    }
    
    // åˆå§‹åŒ–ä¸€äº›ç‰©å“
    playerData.inventory.push(
      { name: 'æ–°æ‰‹å‰‘', rarity: 'common', icon: 'âš”ï¸' },
      { name: 'ç”Ÿå‘½è¯æ°´', rarity: 'common', icon: 'ğŸ§ª' },
      { name: 'æ³•åŠ›è¯æ°´', rarity: 'common', icon: 'ğŸ’§' }
    );
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
    const particleCanvas = document.getElementById('particleCanvas');
    const particleCtx = particleCanvas.getContext('2d', { alpha: true });
    const connectionStatus = document.getElementById('connectionStatus');
    const fpsDisplay = document.getElementById('fps');
    
    // Performance monitoring
    let fps = 0;
    let frameCount = 0;
    let lastFpsUpdate = Date.now();
    
    function updateFPS() {
      frameCount++;
      const now = Date.now();
      if (now - lastFpsUpdate >= 1000) {
        fps = frameCount;
        fpsDisplay.textContent = `FPS: ${fps}`;
        frameCount = 0;
        lastFpsUpdate = now;
      }
    }
    
    // Toast notifications
    function showToast(message, duration = 2000) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), duration);
    }
    
    // Throttle function for performance
    function throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    // Audio System
    const bgMusic = document.getElementById('bgMusic');
    const shootSound = document.getElementById('shootSound');
    const hitSound = document.getElementById('hitSound');
    let musicEnabled = true;
    let sfxEnabled = true;
    
    bgMusic.volume = 0.3;
    shootSound.volume = 0.4;
    hitSound.volume = 0.5;
    
    document.getElementById('musicBtn').addEventListener('click', () => {
      musicEnabled = !musicEnabled;
      const btn = document.getElementById('musicBtn');
      if (musicEnabled) {
        bgMusic.play();
        btn.classList.add('active');
        btn.textContent = 'ğŸµ Music ON';
      } else {
        bgMusic.pause();
        btn.classList.remove('active');
        btn.textContent = 'ğŸµ Music OFF';
      }
    });
    
    document.getElementById('sfxBtn').addEventListener('click', () => {
      sfxEnabled = !sfxEnabled;
      const btn = document.getElementById('sfxBtn');
      btn.classList.toggle('active');
      btn.textContent = sfxEnabled ? 'ğŸ”Š SFX ON' : 'ğŸ”‡ SFX OFF';
    });
    
    function playSound(sound) {
      if (sfxEnabled) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log('Audio play failed:', e));
      }
    }
    
    // Particle System with object pooling
    class Particle {
      constructor() {
        this.reset(0, 0, '#FFF', 0);
      }
      
      reset(x, y, color, velocity) {
        this.x = x;
        this.y = y;
        this.vx = (Math.random() - 0.5) * velocity;
        this.vy = (Math.random() - 0.5) * velocity;
        this.color = color;
        this.life = 1;
        this.decay = 0.02;
        this.size = Math.random() * 4 + 2;
        this.active = true;
      }
      
      update() {
        if (!this.active) return;
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.1;
        this.life -= this.decay;
        if (this.life <= 0) this.active = false;
      }
      
      draw() {
        if (!this.active) return;
        particleCtx.globalAlpha = this.life;
        particleCtx.fillStyle = this.color;
        particleCtx.beginPath();
        particleCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        particleCtx.fill();
      }
    }
    
    // Object pool for particles
    const particlePool = [];
    const MAX_PARTICLES = 500;
    for (let i = 0; i < MAX_PARTICLES; i++) {
      particlePool.push(new Particle());
    }
    
    let particles = [];
    
    function getParticle(x, y, color, velocity) {
      for (let p of particlePool) {
        if (!p.active) {
          p.reset(x, y, color, velocity);
          return p;
        }
      }
      return null;
    }
    
    function createExplosion(x, y, color = '#FFD700') {
      const count = fps > 30 ? 20 : 10; // Reduce particles on low FPS
      for (let i = 0; i < count; i++) {
        const particle = getParticle(x, y, color, 8);
        if (particle && !particles.includes(particle)) {
          particles.push(particle);
        }
      }
    }
    
    function updateParticles() {
      particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
      particleCtx.save();
      
      // Batch drawing for better performance
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.update();
        p.draw();
        if (!p.active) {
          particles.splice(i, 1);
        }
      }
      
      particleCtx.restore();
    }
    
    // Story System
    const storyPanel = document.getElementById('storyPanel');
    const storyText = document.getElementById('storyText');
    const storySpeaker = document.getElementById('storySpeaker');
    
    const storyLines = [
      { speaker: 'Guardian', text: 'Welcome, brave hero! The realm is under siege by dark forces...' },
      { speaker: 'Guardian', text: 'You must gather allies and fight together to restore peace!' },
      { speaker: 'Hero', text: 'I will not let darkness prevail. Let the battle begin!' }
    ];
    
    let currentStoryIndex = 0;
    let storyDisplayed = false;
    
    function showStory(index) {
      if (index >= storyLines.length) return;
      const story = storyLines[index];
      storySpeaker.textContent = `${story.speaker}:`;
      storyText.textContent = story.text;
      storyPanel.classList.add('active');
      
      setTimeout(() => {
        storyPanel.classList.remove('active');
      }, 5000);
    }
    
    // Show opening story after connection
    setTimeout(() => {
      if (!storyDisplayed) {
        showStory(0);
        storyDisplayed = true;
        setTimeout(() => showStory(1), 6000);
        setTimeout(() => showStory(2), 12000);
      }
    }, 3000);

    // Game state
    let myPlayerId = null;
    let currentRoomId = 'lobby';
    let players = {};
    let enemies = {};
    let bullets = {};
    let keys = {};
    let rooms = [];

    // Connect to server
    const socket = io(window.location.origin, {
      transports: ['websocket'],
      upgrade: false
    });

    socket.on('connect', () => {
      connectionStatus.innerHTML = 'âœ… Connected!';
      showToast('ğŸ® Connected to server!');
      setTimeout(() => {
        connectionStatus.style.display = 'none';
        if (musicEnabled) bgMusic.play().catch(e => console.log('Music autoplay blocked'));
      }, 2000);
    });

    socket.on('disconnect', () => {
      connectionStatus.innerHTML = 'âŒ Disconnected<div id="loadingSpinner"></div>';
      connectionStatus.style.display = 'block';
      showToast('âŒ Connection lost!', 3000);
    });

    socket.on('init', (data) => {
      myPlayerId = data.playerId;
      currentRoomId = data.roomId;
      players = data.players;
      enemies = data.enemies;
      bullets = data.bullets;
      rooms = data.rooms || [];
      updatePlayerList();
      updateRoomList();
    });

    socket.on('playerJoined', (player) => {
      players[player.id] = player;
      updatePlayerList();
      showToast(`ğŸ‘‹ ${player.username} joined!`);
    });

    socket.on('playerLeft', (playerId) => {
      const player = players[playerId];
      if (player) {
        showToast(`ğŸ‘‹ ${player.username} left`);
      }
      delete players[playerId];
      updatePlayerList();
    });

    socket.on('playerMoved', (data) => {
      if (players[data.id]) {
        players[data.id].x = data.x;
        players[data.id].y = data.y;
        players[data.id].left = data.left;
        players[data.id].right = data.right;
        players[data.id].isJump = data.isJump;
      }
    });

    socket.on('bulletCreated', (bullet) => {
      bullets[bullet.id] = bullet;
      playSound(shootSound);
      createExplosion(bullet.x, bullet.y, '#FFFF00');
    });

    socket.on('bulletRemoved', (bulletId) => {
      delete bullets[bulletId];
    });

    socket.on('enemySpawned', (enemy) => {
      enemies[enemy.id] = enemy;
      createExplosion(enemy.x + 32, enemy.y + 32, '#FF0000');
    });

    socket.on('enemyKilled', (data) => {
      const enemy = enemies[data.enemyId];
      if (enemy) {
        createExplosion(enemy.x + 32, enemy.y + 32, '#FF4444');
        playSound(hitSound);
      }
      delete enemies[data.enemyId];
      if (data.killerId === myPlayerId) {
        players[myPlayerId].score += 10;
        playerData.gold += 50;
        gainExp(20);
        showToast('ğŸ’° +50é‡‘å¸ â­ +20ç»éªŒ', 2000);
        updateUI();
        updateUIData();
      }
    });

    socket.on('enemyHit', (data) => {
      if (enemies[data.enemyId]) {
        enemies[data.enemyId].health = data.health;
        createExplosion(
          enemies[data.enemyId].x + 32, 
          enemies[data.enemyId].y + 32, 
          '#FFA500'
        );
      }
    });

    socket.on('playerHit', (data) => {
      if (players[data.id]) {
        players[data.id].health = data.health;
        createExplosion(players[data.id].x + 32, players[data.id].y + 32, '#FF6666');
        if (data.id === myPlayerId) {
          playSound(hitSound);
          updateUI();
        }
      }
    });

    socket.on('playerDied', (playerId) => {
      if (players[playerId]) {
        players[playerId].health = 0;
        createExplosion(players[playerId].x + 32, players[playerId].y + 32, '#000000');
        if (playerId === myPlayerId) {
          showToast('ğŸ’€ You died! Respawning...', 2000);
        }
      }
    });

    socket.on('playerRespawned', (player) => {
      players[player.id] = player;
      createExplosion(player.x + 32, player.y + 32, '#00FF00');
      if (player.id === myPlayerId) {
        showToast('âœ¨ Respawned!', 1500);
      }
      if (player.id === myPlayerId) {
        updateUI();
      }
    });

    socket.on('enemiesUpdate', (updatedEnemies) => {
      enemies = updatedEnemies;
    });

    socket.on('bulletsUpdate', (updatedBullets) => {
      bullets = updatedBullets;
    });

    socket.on('roomListUpdate', (roomList) => {
      rooms = roomList;
      updateRoomList();
    });

    socket.on('roomCreated', (data) => {
      socket.emit('joinRoom', data.roomId);
    });

    socket.on('roomJoined', (data) => {
      currentRoomId = data.roomId;
      players = data.players;
      enemies = data.enemies;
      bullets = data.bullets;
      updatePlayerList();
      updateRoomList();
      showToast(`ğŸ  Joined room!`);
    });

    socket.on('roomFull', (roomId) => {
      showToast('âŒ Room is full!', 2000);
    });

    // Keyboard controls with preventDefault for game keys
    document.addEventListener('keydown', (e) => {
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
        e.preventDefault();
      }
      keys[e.key] = true;
    });

    document.addEventListener('keyup', (e) => {
      keys[e.key] = false;
    });

    // Mobile controls
    document.getElementById('leftBtn').addEventListener('touchstart', () => keys['ArrowLeft'] = true);
    document.getElementById('leftBtn').addEventListener('touchend', () => keys['ArrowLeft'] = false);
    document.getElementById('rightBtn').addEventListener('touchstart', () => keys['ArrowRight'] = true);
    document.getElementById('rightBtn').addEventListener('touchend', () => keys['ArrowRight'] = false);
    document.getElementById('jumpBtn').addEventListener('touchstart', () => keys['ArrowUp'] = true);
    document.getElementById('jumpBtn').addEventListener('touchend', () => keys['ArrowUp'] = false);
    document.getElementById('shootBtn').addEventListener('touchstart', () => keys[' '] = true);
    document.getElementById('shootBtn').addEventListener('touchend', () => keys[' '] = false);

    // Game loop with throttled network updates
    let lastShot = 0;
    let lastNetworkUpdate = 0;
    const NETWORK_UPDATE_RATE = 1000 / 30; // 30 updates per second
    
    function gameLoop() {
      if (!myPlayerId || !players[myPlayerId]) {
        requestAnimationFrame(gameLoop);
        return;
      }

      const me = players[myPlayerId];
      let moved = false;
      const now = Date.now();

      // Movement
      if (keys['ArrowLeft'] && me.x > 5) {
        me.x -= me.vel;
        me.left = true;
        me.right = false;
        moved = true;
      } else if (keys['ArrowRight'] && me.x < 500 - me.width - 5) {
        me.x += me.vel;
        me.right = true;
        me.left = false;
        moved = true;
      } else {
        me.left = false;
        me.right = false;
      }

      // Jump
      if (keys['ArrowUp'] && !me.isJump) {
        me.isJump = true;
        me.jumpCount = 10;
        moved = true;
      }

      if (me.isJump) {
        if (me.jumpCount >= -10) {
          const neg = me.jumpCount < 0 ? -1 : 1;
          me.y -= (me.jumpCount ** 2) * 0.5 * neg;
          me.jumpCount -= 1;
        } else {
          me.isJump = false;
          me.jumpCount = 10;
        }
        moved = true;
      }

      // Shoot with cooldown
      if (keys[' '] && now - lastShot > 300) {
        const facing = me.left ? -1 : 1;
        socket.emit('shoot', {
          x: me.x + me.width / 2,
          y: me.y + me.height / 2,
          facing: facing
        });
        lastShot = now;
      }

      // Send movement to server (throttled)
      if (moved && now - lastNetworkUpdate > NETWORK_UPDATE_RATE) {
        socket.emit('playerMove', {
          x: me.x,
          y: me.y,
          left: me.left,
          right: me.right,
          isJump: me.isJump
        });
        lastNetworkUpdate = now;
      }

      // Render
      render();
      updateParticles();
      updateFPS();
      requestAnimationFrame(gameLoop);
    }

    // Cache background rendering
    let backgroundCanvas;
    let backgroundRendered = false;
    
    function renderBackground() {
      if (backgroundRendered) {
        ctx.drawImage(backgroundCanvas, 0, 0);
        return;
      }
      
      backgroundCanvas = document.createElement('canvas');
      backgroundCanvas.width = canvas.width;
      backgroundCanvas.height = canvas.height;
      const bgCtx = backgroundCanvas.getContext('2d');
      
      // Draw animated sky
      const gradient = bgCtx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#1a1a4e');
      gradient.addColorStop(0.5, '#2a4a6a');
      gradient.addColorStop(1, '#3a6a8a');
      bgCtx.fillStyle = gradient;
      bgCtx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw stars
      bgCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      for (let i = 0; i < 50; i++) {
        const x = (i * 73) % canvas.width;
        const y = (i * 97) % (canvas.height - 100);
        const size = (i % 3) + 1;
        bgCtx.beginPath();
        bgCtx.arc(x, y, size, 0, Math.PI * 2);
        bgCtx.fill();
      }
      
      // Draw mountains
      bgCtx.fillStyle = '#2a3a4a';
      bgCtx.beginPath();
      bgCtx.moveTo(0, 460);
      bgCtx.lineTo(100, 380);
      bgCtx.lineTo(200, 420);
      bgCtx.lineTo(300, 360);
      bgCtx.lineTo(400, 400);
      bgCtx.lineTo(500, 370);
      bgCtx.lineTo(500, 460);
      bgCtx.closePath();
      bgCtx.fill();
      
      // Draw ground
      const groundGradient = bgCtx.createLinearGradient(0, 460, 0, 480);
      groundGradient.addColorStop(0, '#4a5a3a');
      groundGradient.addColorStop(1, '#2a3a1a');
      bgCtx.fillStyle = groundGradient;
      bgCtx.fillRect(0, 460, 500, 20);
      
      // Ground details
      bgCtx.fillStyle = '#3a4a2a';
      for (let i = 0; i < 500; i += 20) {
        bgCtx.fillRect(i, 460, 10, 2);
      }
      
      backgroundRendered = true;
      ctx.drawImage(backgroundCanvas, 0, 0);
    }

    function render() {
      // Use cached background
      renderBackground();
      // Draw enemies with glow effect
      Object.values(enemies).forEach(enemy => {
        // Shadow
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(enemy.x + 5, enemy.y + enemy.height, enemy.width - 10, 5);
        
        // Glow
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#FF0000';
        
        // Enemy body with gradient
        const enemyGradient = ctx.createLinearGradient(
          enemy.x, enemy.y, 
          enemy.x, enemy.y + enemy.height
        );
        enemyGradient.addColorStop(0, '#FF6666');
        enemyGradient.addColorStop(1, '#CC0000');
        ctx.fillStyle = enemyGradient;
        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        
        // Enemy eyes
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#FFFF00';
        ctx.beginPath();
        ctx.arc(enemy.x + 20, enemy.y + 20, 4, 0, Math.PI * 2);
        ctx.arc(enemy.x + 44, enemy.y + 20, 4, 0, Math.PI * 2);
        ctx.fill();
        
        // Health bar background
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fillRect(enemy.x, enemy.y - 12, 64, 6);
        
        // Health bar
        const healthPercent = enemy.health / 10;
        const healthColor = healthPercent > 0.5 ? '#00FF00' : healthPercent > 0.25 ? '#FFAA00' : '#FF0000';
        ctx.fillStyle = healthColor;
        ctx.fillRect(enemy.x + 1, enemy.y - 11, 62 * healthPercent, 4);
      });

      // Draw bullets with glow
      Object.values(bullets).forEach(bullet => {
        // Bullet glow
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#FFFF00';
        
        // Bullet trail
        ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
        ctx.beginPath();
        ctx.arc(bullet.x - bullet.facing * 10, bullet.y, 8, 0, Math.PI * 2);
        ctx.fill();
        
        // Main bullet
        const bulletGradient = ctx.createRadialGradient(
          bullet.x, bullet.y, 0,
          bullet.x, bullet.y, 6
        );
        bulletGradient.addColorStop(0, '#FFFFFF');
        bulletGradient.addColorStop(0.5, '#FFFF00');
        bulletGradient.addColorStop(1, '#FF8800');
        ctx.fillStyle = bulletGradient;
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, 6, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 0;
      });

      // Draw players with enhanced graphics
      Object.values(players).forEach(player => {
        const isMe = player.id === myPlayerId;
        
        // Player shadow
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(player.x + 10, player.y + player.height, player.width - 20, 5);
        
        // Player glow
        if (isMe) {
          ctx.shadowBlur = 20;
          ctx.shadowColor = '#00FF00';
        } else {
          ctx.shadowBlur = 10;
          ctx.shadowColor = '#4444FF';
        }
        
        // Player body with gradient
        const playerGradient = ctx.createLinearGradient(
          player.x, player.y,
          player.x, player.y + player.height
        );
        if (isMe) {
          playerGradient.addColorStop(0, '#00FF00');
          playerGradient.addColorStop(1, '#00AA00');
        } else {
          playerGradient.addColorStop(0, '#6666FF');
          playerGradient.addColorStop(1, '#0000AA');
        }
        ctx.fillStyle = playerGradient;
        ctx.fillRect(player.x, player.y, player.width, player.height);
        
        // Player armor highlights
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.fillRect(player.x + 5, player.y + 5, 10, 20);
        ctx.fillRect(player.x + player.width - 15, player.y + 5, 10, 20);
        
        // Player face
        ctx.fillStyle = '#FFE4B5';
        ctx.fillRect(player.x + 20, player.y + 10, 24, 24);
        
        // Eyes
        ctx.fillStyle = '#000000';
        ctx.beginPath();
        ctx.arc(player.x + 28, player.y + 20, 2, 0, Math.PI * 2);
        ctx.arc(player.x + 36, player.y + 20, 2, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 0;
        
        // Name tag with background
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(player.x - 5, player.y - 25, player.width + 10, 18);
        
        // Name text
        ctx.fillStyle = isMe ? '#00FF00' : '#FFFFFF';
        ctx.font = 'bold 12px Cinzel';
        ctx.textAlign = 'center';
        ctx.shadowBlur = 5;
        ctx.shadowColor = isMe ? '#00FF00' : '#FFFFFF';
        ctx.fillText(player.username, player.x + player.width/2, player.y - 10);
        ctx.shadowBlur = 0;
        
        // Health bar (for other players)
        if (!isMe) {
          ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
          ctx.fillRect(player.x, player.y - 32, player.width, 6);
          
          const healthPercent = player.health / 100;
          const healthColor = healthPercent > 0.5 ? '#00FF00' : healthPercent > 0.25 ? '#FFAA00' : '#FF0000';
          ctx.fillStyle = healthColor;
          ctx.fillRect(player.x + 1, player.y - 31, (player.width - 2) * healthPercent, 4);
        }
      });
    }

    function updateUI() {
      if (players[myPlayerId]) {
        document.getElementById('health').textContent = `â¤ï¸ HP: ${players[myPlayerId].health}/${playerData.maxHp}`;
        document.getElementById('score').textContent = `ğŸ† ${playerData.gold.toLocaleString()}é‡‘å¸`;
      }
      document.getElementById('players').textContent = `ğŸ‘¥ Players: ${Object.keys(players).length}`;
      updateUIData();
    }

    function updatePlayerList() {
      const list = document.getElementById('playerList');
      list.innerHTML = '<div style="font-weight: bold; margin-bottom: 5px;">ğŸ® Players Online</div>';
      Object.values(players).forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-item';
        div.textContent = `${player.username} - ${player.score}pts`;
        if (player.id === myPlayerId) {
          div.style.background = 'rgba(0,255,0,0.2)';
        }
        list.appendChild(div);
      });
      updateUI();
    }

    function updateRoomList() {
      const list = document.getElementById('roomList');
      list.innerHTML = '';
      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'room-item';
        if (room.id === currentRoomId) {
          div.classList.add('current');
        }
        div.innerHTML = `
          <div style="font-weight: bold;">${room.name}</div>
          <div style="font-size: 12px; color: #aaa;">${room.playerCount}/${room.maxPlayers} players</div>
        `;
        div.onclick = () => {
          if (room.id !== currentRoomId) {
            socket.emit('joinRoom', room.id);
          }
        };
        list.appendChild(div);
      });
    }

    // Create room button
    document.getElementById('createRoomBtn').addEventListener('click', () => {
      const roomName = prompt('Enter room name:');
      if (roomName) {
        socket.emit('createRoom', roomName);
      }
    });

    // Start game loop
    gameLoop();
  </script>
</body>
</html>
