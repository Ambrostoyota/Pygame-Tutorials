<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pygame Online - Multiplayer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #1a1a2e;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
      color: white;
      overflow: hidden;
    }
    #gameContainer {
      position: relative;
      background: #0f3460;
      border: 3px solid #16213e;
      box-shadow: 0 0 30px rgba(0, 240, 255, 0.3);
    }
    #canvas {
      display: block;
      image-rendering: pixelated;
    }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      pointer-events: none;
    }
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none; /* Show on mobile */
      gap: 10px;
    }
    .btn {
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      color: white;
      padding: 15px 25px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }
    .btn:active {
      background: rgba(255,255,255,0.4);
    }
    #playerList {
      position: absolute;
      top: 60px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
    .player-item {
      padding: 5px;
      margin: 3px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }
    #roomPanel {
      position: absolute;
      top: 60px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
      max-width: 250px;
      max-height: 300px;
      overflow-y: auto;
    }
    #roomPanel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #00ff00;
    }
    .room-item {
      padding: 8px;
      margin: 5px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .room-item:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }
    .room-item.current {
      background: rgba(0,255,0,0.3);
      border: 2px solid #00ff00;
    }
    #createRoomBtn {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      background: #00ff00;
      color: black;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    #createRoomBtn:hover {
      background: #00dd00;
    }
    @media (max-width: 600px) {
      #canvas {
        max-width: 100vw;
        height: auto;
      }
      #controls {
        display: flex;
      }
    }
    #connectionStatus {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      background: rgba(0,0,0,0.8);
      padding: 20px 40px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="canvas" width="500" height="480"></canvas>
    <div id="ui">
      <div id="health">‚ù§Ô∏è HP: 100</div>
      <div id="score">‚≠ê Score: 0</div>
      <div id="players">üë• Players: 1</div>
    </div>
    <div id="playerList"></div>
    <div id="roomPanel">
      <h3>üè† Rooms</h3>
      <div id="roomList"></div>
      <button id="createRoomBtn">‚ûï Create Room</button>
    </div>
    <div id="connectionStatus">üîå Connecting...</div>
    
    <!-- Mobile controls -->
    <div id="controls">
      <button class="btn" id="leftBtn">‚óÄÔ∏è</button>
      <button class="btn" id="jumpBtn">üîº</button>
      <button class="btn" id="shootBtn">üî´</button>
      <button class="btn" id="rightBtn">‚ñ∂Ô∏è</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const connectionStatus = document.getElementById('connectionStatus');

    // Game state
    let myPlayerId = null;
    let currentRoomId = 'lobby';
    let players = {};
    let enemies = {};
    let bullets = {};
    let keys = {};
    let rooms = [];

    // Connect to server
    const socket = io(window.location.origin);

    socket.on('connect', () => {
      connectionStatus.textContent = '‚úÖ Connected!';
      setTimeout(() => connectionStatus.style.display = 'none', 2000);
    });

    socket.on('disconnect', () => {
      connectionStatus.textContent = '‚ùå Disconnected';
      connectionStatus.style.display = 'block';
    });

    socket.on('init', (data) => {
      myPlayerId = data.playerId;
      currentRoomId = data.roomId;
      players = data.players;
      enemies = data.enemies;
      bullets = data.bullets;
      rooms = data.rooms || [];
      updatePlayerList();
      updateRoomList();
    });

    socket.on('playerJoined', (player) => {
      players[player.id] = player;
      updatePlayerList();
    });

    socket.on('playerLeft', (playerId) => {
      delete players[playerId];
      updatePlayerList();
    });

    socket.on('playerMoved', (data) => {
      if (players[data.id]) {
        players[data.id].x = data.x;
        players[data.id].y = data.y;
        players[data.id].left = data.left;
        players[data.id].right = data.right;
        players[data.id].isJump = data.isJump;
      }
    });

    socket.on('bulletCreated', (bullet) => {
      bullets[bullet.id] = bullet;
    });

    socket.on('bulletRemoved', (bulletId) => {
      delete bullets[bulletId];
    });

    socket.on('enemySpawned', (enemy) => {
      enemies[enemy.id] = enemy;
    });

    socket.on('enemyKilled', (data) => {
      delete enemies[data.enemyId];
      if (data.killerId === myPlayerId) {
        players[myPlayerId].score += 10;
        updateUI();
      }
    });

    socket.on('enemyHit', (data) => {
      if (enemies[data.enemyId]) {
        enemies[data.enemyId].health = data.health;
      }
    });

    socket.on('playerHit', (data) => {
      if (players[data.id]) {
        players[data.id].health = data.health;
        if (data.id === myPlayerId) {
          updateUI();
        }
      }
    });

    socket.on('playerDied', (playerId) => {
      if (players[playerId]) {
        players[playerId].health = 0;
      }
    });

    socket.on('playerRespawned', (player) => {
      players[player.id] = player;
      if (player.id === myPlayerId) {
        updateUI();
      }
    });

    socket.on('enemiesUpdate', (updatedEnemies) => {
      enemies = updatedEnemies;
    });

    socket.on('bulletsUpdate', (updatedBullets) => {
      bullets = updatedBullets;
    });

    socket.on('roomListUpdate', (roomList) => {
      rooms = roomList;
      updateRoomList();
    });

    socket.on('roomCreated', (data) => {
      socket.emit('joinRoom', data.roomId);
    });

    socket.on('roomJoined', (data) => {
      currentRoomId = data.roomId;
      players = data.players;
      enemies = data.enemies;
      bullets = data.bullets;
      updatePlayerList();
      updateRoomList();
    });

    socket.on('roomFull', (roomId) => {
      alert('Room is full!');
    });

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      keys[e.key] = true;
    });

    document.addEventListener('keyup', (e) => {
      keys[e.key] = false;
    });

    // Mobile controls
    document.getElementById('leftBtn').addEventListener('touchstart', () => keys['ArrowLeft'] = true);
    document.getElementById('leftBtn').addEventListener('touchend', () => keys['ArrowLeft'] = false);
    document.getElementById('rightBtn').addEventListener('touchstart', () => keys['ArrowRight'] = true);
    document.getElementById('rightBtn').addEventListener('touchend', () => keys['ArrowRight'] = false);
    document.getElementById('jumpBtn').addEventListener('touchstart', () => keys['ArrowUp'] = true);
    document.getElementById('jumpBtn').addEventListener('touchend', () => keys['ArrowUp'] = false);
    document.getElementById('shootBtn').addEventListener('touchstart', () => keys[' '] = true);
    document.getElementById('shootBtn').addEventListener('touchend', () => keys[' '] = false);

    // Game loop
    let lastShot = 0;
    function gameLoop() {
      if (!myPlayerId || !players[myPlayerId]) {
        requestAnimationFrame(gameLoop);
        return;
      }

      const me = players[myPlayerId];
      let moved = false;

      // Movement
      if (keys['ArrowLeft'] && me.x > 5) {
        me.x -= me.vel;
        me.left = true;
        me.right = false;
        moved = true;
      } else if (keys['ArrowRight'] && me.x < 500 - me.width - 5) {
        me.x += me.vel;
        me.right = true;
        me.left = false;
        moved = true;
      }

      // Jump
      if (keys['ArrowUp'] && !me.isJump) {
        me.isJump = true;
        me.jumpCount = 10;
        moved = true;
      }

      if (me.isJump) {
        if (me.jumpCount >= -10) {
          const neg = me.jumpCount < 0 ? -1 : 1;
          me.y -= (me.jumpCount ** 2) * 0.5 * neg;
          me.jumpCount -= 1;
        } else {
          me.isJump = false;
          me.jumpCount = 10;
        }
        moved = true;
      }

      // Shoot
      if (keys[' '] && Date.now() - lastShot > 300) {
        const facing = me.left ? -1 : 1;
        socket.emit('shoot', {
          x: me.x + me.width / 2,
          y: me.y + me.height / 2,
          facing: facing
        });
        lastShot = Date.now();
      }

      // Send movement to server
      if (moved) {
        socket.emit('playerMove', {
          x: me.x,
          y: me.y,
          left: me.left,
          right: me.right,
          isJump: me.isJump
        });
      }

      // Render
      render();
      requestAnimationFrame(gameLoop);
    }

    function render() {
      // Clear canvas
      ctx.fillStyle = '#87CEEB';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw ground
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(0, 460, 500, 20);

      // Draw enemies
      Object.values(enemies).forEach(enemy => {
        ctx.fillStyle = '#FF4444';
        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        
        // Health bar
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(enemy.x, enemy.y - 10, 50, 5);
        ctx.fillStyle = '#00FF00';
        ctx.fillRect(enemy.x, enemy.y - 10, 50 * (enemy.health / 10), 5);
      });

      // Draw bullets
      Object.values(bullets).forEach(bullet => {
        ctx.fillStyle = '#000000';
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, 6, 0, Math.PI * 2);
        ctx.fill();
      });

      // Draw players
      Object.values(players).forEach(player => {
        const isMe = player.id === myPlayerId;
        ctx.fillStyle = isMe ? '#00FF00' : '#4444FF';
        ctx.fillRect(player.x, player.y, player.width, player.height);
        
        // Name tag
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(player.username, player.x + player.width/2, player.y - 5);
        
        // Health bar
        if (!isMe) {
          ctx.fillStyle = '#FF0000';
          ctx.fillRect(player.x, player.y - 15, player.width, 5);
          ctx.fillStyle = '#00FF00';
          ctx.fillRect(player.x, player.y - 15, player.width * (player.health / 100), 5);
        }
      });
    }

    function updateUI() {
      if (players[myPlayerId]) {
        document.getElementById('health').textContent = `‚ù§Ô∏è HP: ${players[myPlayerId].health}`;
        document.getElementById('score').textContent = `‚≠ê Score: ${players[myPlayerId].score}`;
      }
      document.getElementById('players').textContent = `üë• Players: ${Object.keys(players).length}`;
    }

    function updatePlayerList() {
      const list = document.getElementById('playerList');
      list.innerHTML = '<div style="font-weight: bold; margin-bottom: 5px;">üéÆ Players Online</div>';
      Object.values(players).forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-item';
        div.textContent = `${player.username} - ${player.score}pts`;
        if (player.id === myPlayerId) {
          div.style.background = 'rgba(0,255,0,0.2)';
        }
        list.appendChild(div);
      });
      updateUI();
    }

    function updateRoomList() {
      const list = document.getElementById('roomList');
      list.innerHTML = '';
      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'room-item';
        if (room.id === currentRoomId) {
          div.classList.add('current');
        }
        div.innerHTML = `
          <div style="font-weight: bold;">${room.name}</div>
          <div style="font-size: 12px; color: #aaa;">${room.playerCount}/${room.maxPlayers} players</div>
        `;
        div.onclick = () => {
          if (room.id !== currentRoomId) {
            socket.emit('joinRoom', room.id);
          }
        };
        list.appendChild(div);
      });
    }

    // Create room button
    document.getElementById('createRoomBtn').addEventListener('click', () => {
      const roomName = prompt('Enter room name:');
      if (roomName) {
        socket.emit('createRoom', roomName);
      }
    });

    // Start game loop
    gameLoop();
  </script>
</body>
</html>
